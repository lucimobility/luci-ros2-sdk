name: Create Next Documentation

on:
  push:
    branches:
      - "main"
  schedule:
  # * is a special character in YAML so you have to quote this string
  # Run an update everyday at 5:30 am to keep next updated
    - cron: "30 5 * * *"
  workflow_dispatch:

env:
  SDK_REPO: ${{github.event.repository.name}}
  BUILD_TYPE: next

jobs:
  documentation:
    runs-on: ubuntu-latest
    container: luci.jfrog.io/ros2-sdk-docker-local/sdk-docs-deployment:latest
    steps:
      - name: Generate token from GitHub App
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: |
            luci-ros2-sdk
            luci-sdk-docs
            luci-ros2-msgs
            luci-ros2-grpc
            luci-ros2-transforms
            luci-ros2-keyboard-teleop
            luci-ros2-third-party

      - name: Checkout SDK
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}
          path: luci-ros2-sdk
          token: ${{ steps.generate-token.outputs.token }}

      - name: Checkout Messages
        uses: actions/checkout@v3
        with:
          repository: lucimobility/luci-ros2-msgs
          ref: main
          path: luci-ros2-msgs
          token: ${{ steps.generate-token.outputs.token }}

      - name: Checkout GRPC
        uses: actions/checkout@v3
        with:
          repository: lucimobility/luci-ros2-grpc
          ref: main
          path: luci-ros2-grpc
          token: ${{ steps.generate-token.outputs.token }}

      - name: Checkout Transforms
        uses: actions/checkout@v3
        with:
          repository: lucimobility/luci-ros2-transforms
          ref: main
          path: luci-ros2-transforms
          token: ${{ steps.generate-token.outputs.token }}

      - name: Checkout Keyboard
        uses: actions/checkout@v3
        with:
          repository: lucimobility/luci-ros2-keyboard-teleop
          ref: main
          path: luci-ros2-keyboard-teleop
          token: ${{ steps.generate-token.outputs.token }}

      - name: Checkout Third Party
        uses: actions/checkout@v3
        with:
          repository: lucimobility/luci-ros2-third-party
          ref: main
          path: luci-ros2-third-party
          token: ${{ steps.generate-token.outputs.token }}

      - name: Checkout Docs
        uses: actions/checkout@v3
        with:
          repository: lucimobility/${{vars.DOCS_REPO}}
          ref: main
          path: ${{vars.DOCS_REPO}}
          token: ${{ steps.generate-token.outputs.token }}

      - name: Build docs
        run: |
          cd luci-ros2-sdk
          ./deployment-scripts/build-docs.sh
        shell: bash
        env:
          BUILD_TYPE: ${{env.BUILD_TYPE}}
          REF_NAME: ${{github.ref_name}}
          DOCS_REPO: ${{vars.DOCS_REPO}}